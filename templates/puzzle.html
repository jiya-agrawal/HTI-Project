<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTI Experiment - Puzzle {{ step }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (step / 4) * 100 }}%"></div>
        </div>
        
        <div class="progress-indicator">
            <span>Puzzle {{ step }} of 4 | LOA {{ loa }}</span>
        </div>
        
        <div class="puzzle-container">
            <!-- Puzzle Prompt Section -->
            <div class="puzzle-section">
                <h2>üß© Puzzle {{ step }}</h2>
                <div class="puzzle-prompt">
                    {{ puzzle.prompt | safe }}
                </div>
                
                <div class="timer-display">
                    <span id="timer">‚è±Ô∏è Time: 00:00</span>
                </div>
            </div>
            
            <!-- AI Assistant Section (LOA 3: step-by-step supervision) -->
            {% if loa == 3 %}
            <div class="ai-section">
                <h3>ü§ñ AI Assistant (Step-by-step)</h3>
                
                <div id="ai-steps" class="ai-reasoning">
                    {% if not gemini_configured %}
                    <p class="info-text">
                        The AI will walk through its reasoning in multiple steps based on a predefined explanation.
                        You can choose to let it <strong>continue</strong> or ask it to <strong>retry</strong> a step.
                    </p>
                    {% else %}
                    <p class="info-text">
                        The AI will solve this puzzle <strong>step by step</strong>. After each step, you can decide
                        whether it should continue or rethink that step.
                    </p>
                    {% endif %}
                </div>
                
                <div class="button-group">
                    <button id="start-ai-btn" class="btn btn-primary">Start AI</button>
                    <button id="continue-step-btn" class="btn btn-success" style="display: none;">Continue</button>
                    <button id="retry-step-btn" class="btn btn-warning" style="display: none;">Retry this step</button>
                </div>
                
                <p id="loa3-retry-info" class="help-text"></p>
            </div>
            {% endif %}
            
            <!-- AI Solution for LOA 4 (Reasoning hidden initially) -->
            {% if loa == 4 %}
            <div class="ai-section">
                <h3>ü§ñ AI Solution</h3>
                
                <div class="ai-solution">
                    <p class="ai-answer">{{ ai_solution }}</p>
                </div>
                
                <div id="ai-reasoning-loa4" class="ai-reasoning" style="display: none;">
                    <h4>AI Reasoning:</h4>
                    <p>{{ ai_reasoning }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Drag and Drop Solution Builder (All LOAs) -->
            <div class="interaction-section">
                <h3>üéØ Build Your Solution:</h3>
                <p class="instruction-text">Drag and drop the items below to create the correct sequence</p>
                
                <!-- Available Items Pool -->
                <div class="items-pool">
                    <h4>Available Items:</h4>
                    <div id="source-items" class="drag-container">
                        {% for element in puzzle.elements %}
                        <div class="drag-item" draggable="true" data-element="{{ element }}">
                            {{ element }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Solution Drop Zone -->
                <div class="solution-area">
                    <h4>Your Solution Sequence:</h4>
                    <div id="solution-zone" class="drop-zone">
                        <div class="empty-state">Drag items here to build your solution</div>
                    </div>
                    <button id="clear-solution-btn" class="btn btn-secondary" style="display: none;">üîÑ Clear Solution</button>
                </div>
                
                <!-- LOA-Specific Controls -->
                {% if loa == 2 %}
                <!-- LOA 2: Hint System -->
                <div class="hint-section">
                    <button id="hint-btn" class="btn btn-primary">üí° Get Hint (<span id="hints-remaining">{{ puzzle.hints|default([])|length }}</span> remaining)</button>
                    
                    <div id="hints-container" style="margin-top: 15px;">
                        <!-- Hints will appear here dynamically -->
                    </div>
                </div>
                {% elif loa == 4 %}
                <!-- LOA 4: Accept/View/Reject Controls -->
                <div class="loa4-controls" style="margin-top: 20px;">
                    <div class="button-group">
                        <button id="accept-loa4-btn" class="btn btn-success">‚úì Accept</button>
                        <button id="view-reasoning-btn" class="btn btn-primary">üëÅ View AI Reasoning</button>
                        <button id="reject-loa4-btn" class="btn btn-danger">‚úó Reject & Modify</button>
                    </div>
                </div>
                {% endif %}
                
                <!-- Submit Button (appears after action taken) -->
                <div id="submit-container" style="display: none; margin-top: 20px;">
                    <button id="submit-btn" class="btn btn-primary">Continue to Questionnaire ‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- Awareness Quiz Modal (shown first after submit) -->
        <div id="awareness-modal" class="modal">
            <div class="modal-content awareness-modal-content">
                <h2>üß† Awareness Quiz</h2>
                <p class="info-text">Please answer the following questions about the puzzle you just solved. Answer from memory without looking back at the puzzle.</p>
                
                <div class="awareness-questions-container">
                    {% for question in puzzle.awareness_Q %}
                    <div class="question awareness-question">
                        <label>{{ question }}</label>
                        <textarea name="awareness_q{{ loop.index }}" rows="2" placeholder="Type your answer here..." required></textarea>
                    </div>
                    {% endfor %}
                </div>
                
                <button id="submit-awareness-btn" class="btn btn-primary">Continue to Trust Survey ‚Üí</button>
            </div>
        </div>
        
        <!-- Post-Task Trust Survey Modal (shown after awareness quiz) -->
        <div id="trust-survey-modal" class="modal">
            <div class="modal-content trust-survey-content">
                <h2>üìä Trust Survey (Post-Task)</h2>
                <p class="info-text">Based on your experience with the AI in this puzzle, please rate your agreement with the following statements.</p>
                
                <div class="trust-questions-container">
                    <div class="trust-question">
                        <label>1. The AI is capable of interpreting situations correctly.</label>
                        <div class="likert-scale-5">
                            <div class="likert-labels">
                                <span>Strongly disagree</span>
                                <span>Rather disagree</span>
                                <span>Neither disagree nor agree</span>
                                <span>Rather agree</span>
                                <span>Strongly agree</span>
                            </div>
                            <div class="likert-options">
                                <label><input type="radio" name="post_trust_q1" value="1" required><span>(1)</span></label>
                                <label><input type="radio" name="post_trust_q1" value="2"><span>(2)</span></label>
                                <label><input type="radio" name="post_trust_q1" value="3"><span>(3)</span></label>
                                <label><input type="radio" name="post_trust_q1" value="4"><span>(4)</span></label>
                                <label><input type="radio" name="post_trust_q1" value="5"><span>(5)</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trust-question">
                        <label>2. The AI works reliably.</label>
                        <div class="likert-scale-5">
                            <div class="likert-labels">
                                <span>Strongly disagree</span>
                                <span>Rather disagree</span>
                                <span>Neither disagree nor agree</span>
                                <span>Rather agree</span>
                                <span>Strongly agree</span>
                            </div>
                            <div class="likert-options">
                                <label><input type="radio" name="post_trust_q2" value="1" required><span>(1)</span></label>
                                <label><input type="radio" name="post_trust_q2" value="2"><span>(2)</span></label>
                                <label><input type="radio" name="post_trust_q2" value="3"><span>(3)</span></label>
                                <label><input type="radio" name="post_trust_q2" value="4"><span>(4)</span></label>
                                <label><input type="radio" name="post_trust_q2" value="5"><span>(5)</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trust-question">
                        <label>3. I was able to understand why things happened.</label>
                        <div class="likert-scale-5">
                            <div class="likert-labels">
                                <span>Strongly disagree</span>
                                <span>Rather disagree</span>
                                <span>Neither disagree nor agree</span>
                                <span>Rather agree</span>
                                <span>Strongly agree</span>
                            </div>
                            <div class="likert-options">
                                <label><input type="radio" name="post_trust_q3" value="1" required><span>(1)</span></label>
                                <label><input type="radio" name="post_trust_q3" value="2"><span>(2)</span></label>
                                <label><input type="radio" name="post_trust_q3" value="3"><span>(3)</span></label>
                                <label><input type="radio" name="post_trust_q3" value="4"><span>(4)</span></label>
                                <label><input type="radio" name="post_trust_q3" value="5"><span>(5)</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trust-question">
                        <label>4. The AI might make sporadic errors.</label>
                        <div class="likert-scale-5">
                            <div class="likert-labels">
                                <span>Strongly disagree</span>
                                <span>Rather disagree</span>
                                <span>Neither disagree nor agree</span>
                                <span>Rather agree</span>
                                <span>Strongly agree</span>
                            </div>
                            <div class="likert-options">
                                <label><input type="radio" name="post_trust_q4" value="1" required><span>(1)</span></label>
                                <label><input type="radio" name="post_trust_q4" value="2"><span>(2)</span></label>
                                <label><input type="radio" name="post_trust_q4" value="3"><span>(3)</span></label>
                                <label><input type="radio" name="post_trust_q4" value="4"><span>(4)</span></label>
                                <label><input type="radio" name="post_trust_q4" value="5"><span>(5)</span></label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trust-question">
                        <label>5. I am confident about the AI's capabilities.</label>
                        <div class="likert-scale-5">
                            <div class="likert-labels">
                                <span>Strongly disagree</span>
                                <span>Rather disagree</span>
                                <span>Neither disagree nor agree</span>
                                <span>Rather agree</span>
                                <span>Strongly agree</span>
                            </div>
                            <div class="likert-options">
                                <label><input type="radio" name="post_trust_q5" value="1" required><span>(1)</span></label>
                                <label><input type="radio" name="post_trust_q5" value="2"><span>(2)</span></label>
                                <label><input type="radio" name="post_trust_q5" value="3"><span>(3)</span></label>
                                <label><input type="radio" name="post_trust_q5" value="4"><span>(4)</span></label>
                                <label><input type="radio" name="post_trust_q5" value="5"><span>(5)</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="submit-trust-survey-btn" class="btn btn-primary modal-submit-btn">Submit & Continue</button>
            </div>
        </div>
    </div>
    
    <script>
        // Data collection variables
        const LOA = {{ loa }};
        const puzzleStartTime = Date.now();
        let decisionStartTime = null;
        let interactionCount = 0;
        let finalAnswer = '';
        let acceptedAdvice = false;
        let overridden = false;
        
        // Timer
        let timerInterval;
        let elapsedSeconds = 0;
        
        function startTimer() {
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                document.getElementById('timer').textContent = 
                    `‚è±Ô∏è Time: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        // Start timer IMMEDIATELY
        startTimer();
        
        // Log interaction
        async function logInteraction(type, details = {}) {
            interactionCount++;
            await fetch('/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: type,
                    details: details
                })
            });
        }
        
        // Show submit button
        function showSubmitButton() {
            document.getElementById('submit-container').style.display = 'block';
        }
        
        // ============== DRAG AND DROP FUNCTIONALITY ==============
        const solutionZone = document.getElementById('solution-zone');
        const sourceItems = document.getElementById('source-items');
        const clearBtn = document.getElementById('clear-solution-btn');
        let solutionSequence = [];
        let draggedElement = null;
        let isModifyingAllowed = true; // For LOA 3 and 4 initial lock
        let loa4DecisionMade = false; // For LOA 4 - tracks if accept/reject was pressed
        
        // Get current solution as array
        function getCurrentSolution() {
            if (!solutionZone) return [];
            const items = solutionZone.querySelectorAll('.drag-item');
            return Array.from(items).map(item => item.dataset.element);
        }
        
        // Update final answer when solution changes
        function updateFinalAnswer() {
            solutionSequence = getCurrentSolution();
            finalAnswer = solutionSequence.join(', ');
            
            if (solutionSequence.length > 0) {
                if (clearBtn) clearBtn.style.display = 'inline-block';
                // Hide empty state
                const emptyState = solutionZone.querySelector('.empty-state');
                if (emptyState) emptyState.style.display = 'none';
                
                // Show submit button if solution is complete
                const totalElements = {{ puzzle.elements|length }};
                if (solutionSequence.length === totalElements) {
                    // For LOA 4, only show submit after accept/reject decision is made
                    if (LOA === 4 && !loa4DecisionMade) {
                        // Don't show submit yet for LOA 4
                    } else {
                        showSubmitButton();
                    }
                }
            } else {
                if (clearBtn) clearBtn.style.display = 'none';
                const emptyState = solutionZone.querySelector('.empty-state');
                if (emptyState) emptyState.style.display = 'block';
            }
        }
        
        // Drag start handler
        function handleDragStart(e) {
            if (!isModifyingAllowed) return;
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            logInteraction('drag_start', { element: this.dataset.element });
        }
        
        // Drag end handler
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
        }
        
        // Drag over handler
        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        // Drop handler for solution zone
        function handleDropInSolution(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (!draggedElement || !isModifyingAllowed || !solutionZone) return false;
            
            e.preventDefault();
            
            const dropTarget = e.target;
            
            // If dropping on another item, insert before it
            if (dropTarget.classList.contains('drag-item') && dropTarget !== draggedElement) {
                solutionZone.insertBefore(draggedElement, dropTarget);
            } else if (dropTarget === solutionZone || dropTarget.classList.contains('empty-state')) {
                // Dropping in empty zone or on empty state
                solutionZone.appendChild(draggedElement);
            }
            
            logInteraction('drop_in_solution', { 
                element: draggedElement.dataset.element,
                position: Array.from(solutionZone.children).indexOf(draggedElement)
            });
            
            updateFinalAnswer();
            return false;
        }
        
        // Drop handler for source (return to pool)
        function handleDropInSource(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (!draggedElement || !isModifyingAllowed) return false;
            
            e.preventDefault();
            if (sourceItems) sourceItems.appendChild(draggedElement);
            
            logInteraction('return_to_pool', { element: draggedElement.dataset.element });
            updateFinalAnswer();
            return false;
        }
        
        // Initialize drag and drop for all items
        function initializeDragAndDrop() {
            const allItems = document.querySelectorAll('.drag-item');
            allItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
            
            if (solutionZone) {
                solutionZone.addEventListener('dragover', handleDragOver);
                solutionZone.addEventListener('drop', handleDropInSolution);
            }
            
            if (sourceItems) {
                sourceItems.addEventListener('dragover', handleDragOver);
                sourceItems.addEventListener('drop', handleDropInSource);
            }
        }
        
        // Clear solution button
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                const itemsInSolution = solutionZone ? solutionZone.querySelectorAll('.drag-item') : [];
                itemsInSolution.forEach(item => {
                    if (sourceItems) sourceItems.appendChild(item);
                });
                logInteraction('clear_solution');
                updateFinalAnswer();
            });
        }
        
        // ============== LOA-SPECIFIC LOGIC ==============
        
        // LOA 1: Manual drag and drop
        if (LOA === 1) {
            decisionStartTime = Date.now();
            initializeDragAndDrop();
        }
        
        // LOA 2: Drag and drop with hints
        if (LOA === 2) {
            decisionStartTime = Date.now();
            initializeDragAndDrop();
            
            const hints = {{ puzzle.hints | default([]) | tojson }};
            let currentHintIndex = 0;
            
            const hintBtn = document.getElementById('hint-btn');
            const hintsContainer = document.getElementById('hints-container');
            const hintsRemaining = document.getElementById('hints-remaining');
            
            if (hintBtn && hints.length > 0) {
                hintBtn.addEventListener('click', () => {
                    if (currentHintIndex < hints.length) {
                        const hintDiv = document.createElement('div');
                        hintDiv.className = 'hint-item';
                        hintDiv.innerHTML = `<strong>Hint ${currentHintIndex + 1}:</strong> ${hints[currentHintIndex]}`;
                        hintsContainer.appendChild(hintDiv);
                        
                        logInteraction('request_hint', { 
                            hint_number: currentHintIndex + 1,
                            hint_text: hints[currentHintIndex]
                        });
                        
                        currentHintIndex++;
                        hintsRemaining.textContent = hints.length - currentHintIndex;
                        
                        if (currentHintIndex >= hints.length) {
                            hintBtn.disabled = true;
                            hintBtn.textContent = 'üí° No more hints';
                        }
                    }
                });
            }
        }
        
        // LOA 3: Step-by-step AI reasoning with Continue/Retry
        if (LOA === 3) {
            decisionStartTime = Date.now();
            
            // Allow participant to build their own final sequence at any time
            initializeDragAndDrop();
            document.querySelectorAll('.drag-item').forEach(item => {
                item.style.opacity = '1';
                item.style.cursor = 'grab';
            });
            
            const aiStepsContainer = document.getElementById('ai-steps');
            const startAiBtn = document.getElementById('start-ai-btn');
            const continueBtn = document.getElementById('continue-step-btn');
            const retryBtn = document.getElementById('retry-step-btn');
            const retryInfo = document.getElementById('loa3-retry-info');
            
            let loa3State = {
                started: false,
                currentStepIndex: -1,
                retriesThisStep: 0,
                totalRetries: 0,
                maxRetriesPerStep: 3,
                maxRetriesTotal: 4
            };
            
            function renderSteps(steps, highlightIndex = null) {
                aiStepsContainer.innerHTML = '';
                if (!steps || steps.length === 0) {
                    aiStepsContainer.innerHTML = '<p class="info-text">No AI steps yet. Click "Start AI" to begin.</p>';
                    return;
                }
                
                steps.forEach((stepText, idx) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'hint-item';
                    if (highlightIndex !== null && idx === highlightIndex) {
                        stepDiv.classList.add('highlight-step');
                    }
                    stepDiv.innerHTML = `<strong>Step ${idx + 1}:</strong> ${stepText}`;
                    aiStepsContainer.appendChild(stepDiv);
                });
            }
            
            function updateRetryInfo() {
                retryInfo.textContent = `Retries for this step: ${loa3State.retriesThisStep} / ${loa3State.maxRetriesPerStep} | Total retries: ${loa3State.totalRetries} / ${loa3State.maxRetriesTotal}`;
            }
            
            async function callLoa3Endpoint(action, extraPayload = {}) {
                if (action === 'retry') {
                    retryBtn.disabled = true;
                }
                try {
                    const url = action === 'start' ? '/loa3/start' : '/loa3/step';
                    const payload = action === 'start' ? {} : { action, ...extraPayload };
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        alert(data.error || 'Error communicating with AI. Please continue solving on your own.');
                        if (action === 'retry') {
                            retryBtn.disabled = false;
                        }
                        return;
                    }
                    
                    const {
                        steps,
                        current_step_index,
                        retries_this_step,
                        total_retries,
                        max_retries_per_step,
                        max_retries_total,
                        is_final,
                        final_sequence
                    } = data;
                    
                    loa3State.currentStepIndex = typeof current_step_index === 'number' ? current_step_index : loa3State.currentStepIndex;
                    loa3State.retriesThisStep = typeof retries_this_step === 'number' ? retries_this_step : loa3State.retriesThisStep;
                    loa3State.totalRetries = typeof total_retries === 'number' ? total_retries : loa3State.totalRetries;
                    loa3State.maxRetriesPerStep = typeof max_retries_per_step === 'number' ? max_retries_per_step : loa3State.maxRetriesPerStep;
                    loa3State.maxRetriesTotal = typeof max_retries_total === 'number' ? max_retries_total : loa3State.maxRetriesTotal;
                    
                    if (steps) {
                        renderSteps(steps, action === 'retry' ? loa3State.currentStepIndex : null);
                    } else if (data.message) {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'info-text';
                        msgDiv.textContent = data.message;
                        aiStepsContainer.appendChild(msgDiv);
                    }
                    
                    updateRetryInfo();
                    
                    // Show continue/retry buttons only if NOT final
                    if (is_final) {
                        continueBtn.style.display = 'none';
                        retryBtn.style.display = 'none';
                        
                        // Append a message that AI is done
                        const doneDiv = document.createElement('div');
                        doneDiv.className = 'final-solution-display';
                        doneDiv.innerHTML = "<strong>AI has finished reasoning.</strong> The solution has been applied below.";
                        aiStepsContainer.appendChild(doneDiv);
                        
                        // If final sequence is provided, populate the drag and drop
                        if (final_sequence) {
                            const sequence = final_sequence.split(',').map(s => s.trim());
                            // Clear current solution
                            const itemsInSolution = solutionZone.querySelectorAll('.drag-item');
                            itemsInSolution.forEach(item => sourceItems.appendChild(item));
                            
                            // Populate new solution
                            sequence.forEach(element => {
                                const item = sourceItems.querySelector(`[data-element="${element}"]`);
                                if (item) {
                                    solutionZone.appendChild(item);
                                }
                            });
                            updateFinalAnswer();
                            // Enable modifications for user to verify/tweak if they want
                            isModifyingAllowed = true;
                            showSubmitButton();
                        }
                    } else {
                        // Show controls for next step
                        continueBtn.style.display = 'inline-block';
                        retryBtn.style.display = 'inline-block';
                        
                        // Disable retry if limits are reached
                        const retryLimitReached =
                            loa3State.retriesThisStep >= loa3State.maxRetriesPerStep ||
                            loa3State.totalRetries >= loa3State.maxRetriesTotal;
                        retryBtn.disabled = retryLimitReached;
                    }
                    
                } catch (error) {
                    alert('Error communicating with AI. Please continue solving on your own.');
                } finally {
                    if (action === 'retry') {
                        const retryLimitReached =
                            loa3State.retriesThisStep >= loa3State.maxRetriesPerStep ||
                            loa3State.totalRetries >= loa3State.maxRetriesTotal;
                        retryBtn.disabled = retryLimitReached;
                    }
                }
            }
            
            startAiBtn.addEventListener('click', async () => {
                if (loa3State.started) return;
                loa3State.started = true;
                startAiBtn.disabled = true;
                await logInteraction('loa3_start_ai');
                await callLoa3Endpoint('start');
            });
            
            continueBtn.addEventListener('click', async () => {
                await logInteraction('loa3_continue_step', {
                    current_step_index: loa3State.currentStepIndex
                });
                await callLoa3Endpoint('continue');
            });
            
            retryBtn.addEventListener('click', async () => {
                await logInteraction('loa3_retry_step', {
                    current_step_index: loa3State.currentStepIndex,
                    retries_this_step: loa3State.retriesThisStep,
                    total_retries: loa3State.totalRetries
                });
                overridden = true; // Participant has challenged the AI
                await callLoa3Endpoint('retry', {
                    step_number: loa3State.currentStepIndex + 1
                });
            });
        }
        
        // LOA 4: Pre-fill AI solution, allow accept/view/reject
        if (LOA === 4) {
            decisionStartTime = Date.now();
            let reasoningViewed = false;
            
            // Get elements for pre-population (use the puzzle elements in order)
            const puzzleElements = {{ puzzle.elements | tojson }};
            
            // Pre-populate solution zone with elements (showing AI's proposed order)
            // For LOA 4, we show all elements as the AI's suggested arrangement
            puzzleElements.forEach(element => {
                const item = sourceItems.querySelector(`[data-element="${element}"]`);
                if (item) {
                    solutionZone.appendChild(item);
                }
            });
            updateFinalAnswer();
            
            // Initially lock modifications
            isModifyingAllowed = false;
            document.querySelectorAll('.drag-item').forEach(item => {
                item.style.opacity = '0.7';
                item.style.cursor = 'not-allowed';
            });
            
            const acceptBtn = document.getElementById('accept-loa4-btn');
            const viewReasoningBtn = document.getElementById('view-reasoning-btn');
            const rejectBtn = document.getElementById('reject-loa4-btn');
            
            if (acceptBtn) {
                acceptBtn.addEventListener('click', () => {
                    logInteraction('accept_ai_solution', { reasoning_viewed: reasoningViewed });
                    acceptedAdvice = true;
                    loa4DecisionMade = true;
                    showSubmitButton();
                    document.querySelectorAll('.loa4-controls button').forEach(btn => btn.disabled = true);
                });
            }
            
            if (viewReasoningBtn) {
                viewReasoningBtn.addEventListener('click', () => {
                    const reasoningDiv = document.getElementById('ai-reasoning-loa4');
                    if (reasoningDiv && reasoningDiv.style.display === 'none') {
                        reasoningDiv.style.display = 'block';
                        reasoningViewed = true;
                        logInteraction('view_ai_reasoning');
                        viewReasoningBtn.textContent = 'üëÅ Hide AI Reasoning';
                    } else if (reasoningDiv) {
                        reasoningDiv.style.display = 'none';
                        viewReasoningBtn.textContent = 'üëÅ View AI Reasoning';
                    }
                });
            }
            
            if (rejectBtn) {
                rejectBtn.addEventListener('click', () => {
                    logInteraction('reject_ai_solution', { reasoning_viewed: reasoningViewed });
                    overridden = true;
                    isModifyingAllowed = true;
                    loa4DecisionMade = true;
                    
                    // Enable drag and drop
                    initializeDragAndDrop();
                    document.querySelectorAll('.drag-item').forEach(item => {
                        item.style.opacity = '1';
                        item.style.cursor = 'grab';
                    });
                
                    if (acceptBtn) acceptBtn.disabled = true;
                    rejectBtn.disabled = true;
                
                    // Monitor changes to solution
                    const observer = new MutationObserver(() => {
                        if (getCurrentSolution().length > 0) {
                            showSubmitButton();
                        }
                    });
                    observer.observe(solutionZone, { childList: true });
                });
            }
        }
        
        // Submit button handler - show awareness quiz first
        const submitBtn = document.getElementById('submit-btn');
        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                if (!finalAnswer || finalAnswer.trim().length === 0) {
                    alert('Please provide a solution before continuing.');
                    return;
                }
                
                clearInterval(timerInterval);
                document.getElementById('awareness-modal').style.display = 'flex';
            });
        }
        
        // Store data temporarily
        let awarenessAnswers = {};
        
        // Awareness quiz submission - move to questionnaire
        const submitAwarenessBtn = document.getElementById('submit-awareness-btn');
        if (submitAwarenessBtn) {
            submitAwarenessBtn.addEventListener('click', async () => {
                // Collect all awareness quiz answers
                awarenessAnswers = {};
                const textareas = document.querySelectorAll('.awareness-question textarea');
                let allAnswered = true;
                
                textareas.forEach((textarea, index) => {
                    const answer = textarea.value.trim();
                    if (!answer) {
                        allAnswered = false;
                    }
                    awarenessAnswers[`Q${index + 1}`] = answer;
                });
                
                if (!allAnswered) {
                    alert('Please answer all awareness questions before continuing.');
                    return;
                }
                
                // Hide awareness modal and show trust survey
                document.getElementById('awareness-modal').style.display = 'none';
                document.getElementById('trust-survey-modal').style.display = 'flex';
            });
        }
        
        // Trust Survey submission - final submit
        const submitTrustSurveyBtn = document.getElementById('submit-trust-survey-btn');
        if (submitTrustSurveyBtn) {
            submitTrustSurveyBtn.addEventListener('click', async () => {
                // Validate all trust questions are answered
                const postTrustQ1 = document.querySelector('input[name="post_trust_q1"]:checked');
                const postTrustQ2 = document.querySelector('input[name="post_trust_q2"]:checked');
                const postTrustQ3 = document.querySelector('input[name="post_trust_q3"]:checked');
                const postTrustQ4 = document.querySelector('input[name="post_trust_q4"]:checked');
                const postTrustQ5 = document.querySelector('input[name="post_trust_q5"]:checked');
                
                if (!postTrustQ1 || !postTrustQ2 || !postTrustQ3 || !postTrustQ4 || !postTrustQ5) {
                    alert('Please answer all trust survey questions before continuing.');
                    return;
                }
                
                const decisionLatency = decisionStartTime ? (Date.now() - decisionStartTime) / 1000 : 0;
                
                // Collect post-task trust survey answers
                const postTrustAnswers = {
                    Q1: parseInt(postTrustQ1.value),
                    Q2: parseInt(postTrustQ2.value),
                    Q3: parseInt(postTrustQ3.value),
                    Q4: parseInt(postTrustQ4.value),
                    Q5: parseInt(postTrustQ5.value)
                };
                
                const submissionData = {
                    final_answer: finalAnswer,
                    decision_latency: decisionLatency,
                    accepted_advice: acceptedAdvice,
                    overridden: overridden,
                    awareness_quiz_answers: awarenessAnswers,
                    post_trust_survey: postTrustAnswers
                };
                
                try {
                    const response = await fetch('/submit-puzzle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(submissionData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (data.next_step === 'loa_intro') {
                            window.location.href = '/loa-intro';
                        } else {
                            window.location.href = '/final';
                        }
                    }
                } catch (error) {
                    alert('Error submitting data. Please try again.');
                }
            });
        }
    </script>
</body>
</html>
