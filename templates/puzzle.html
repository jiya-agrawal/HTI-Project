<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTI Experiment - Puzzle {{ step }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (step / 4) * 100 }}%"></div>
        </div>
        
        <div class="progress-indicator">
            <span>Puzzle {{ step }} of 4 | LOA {{ loa }}</span>
        </div>
        
        <div class="puzzle-container">
            <!-- Puzzle Prompt Section -->
            <div class="puzzle-section">
                <h2>üß© Puzzle {{ step }}</h2>
                <div class="puzzle-prompt">
                    {{ puzzle.prompt | safe }}
                </div>
                
                <div class="timer-display">
                    <span id="timer">‚è±Ô∏è Time: 00:00</span>
                </div>
            </div>
            
            <!-- AI Assistant Section (Only for LOA 3) -->
            {% if loa == 3 %}
            <div class="ai-section">
                <h3>ü§ñ AI Assistant</h3>
                
                <div class="ai-reasoning">
                    <h4>AI Reasoning:</h4>
                    <p>{{ ai_reasoning }}</p>
                </div>
                
                <div class="ai-solution">
                    <h4>AI Solution:</h4>
                    <p class="ai-answer">{{ ai_solution }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- AI Solution for LOA 4 (Reasoning hidden initially) -->
            {% if loa == 4 %}
            <div class="ai-section">
                <h3>ü§ñ AI Solution</h3>
                
                <div class="ai-solution">
                    <p class="ai-answer">{{ ai_solution }}</p>
                </div>
                
                <div id="ai-reasoning-loa4" class="ai-reasoning" style="display: none;">
                    <h4>AI Reasoning:</h4>
                    <p>{{ ai_reasoning }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Drag and Drop Solution Builder (All LOAs) -->
            <div class="interaction-section">
                <h3>üéØ Build Your Solution:</h3>
                <p class="instruction-text">Drag and drop the items below to create the correct sequence</p>
                
                <!-- Available Items Pool -->
                <div class="items-pool">
                    <h4>Available Items:</h4>
                    <div id="source-items" class="drag-container">
                        {% for element in puzzle.elements %}
                        <div class="drag-item" draggable="true" data-element="{{ element }}">
                            {{ element }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Solution Drop Zone -->
                <div class="solution-area">
                    <h4>Your Solution Sequence:</h4>
                    <div id="solution-zone" class="drop-zone">
                        <div class="empty-state">Drag items here to build your solution</div>
                    </div>
                    <button id="clear-solution-btn" class="btn btn-secondary" style="display: none;">üîÑ Clear Solution</button>
                </div>
                
                <!-- LOA-Specific Controls -->
                {% if loa == 2 %}
                <!-- LOA 2: Hint System -->
                <div class="hint-section">
                    <button id="hint-btn" class="btn btn-primary">üí° Get Hint (<span id="hints-remaining">{{ puzzle.hints|length }}</span> remaining)</button>
                    
                    <div id="hints-container" style="margin-top: 15px;">
                        <!-- Hints will appear here dynamically -->
                    </div>
                </div>
                {% elif loa == 3 %}
                <!-- LOA 3: Approve/Intervene Controls -->
                <div class="loa3-controls" style="margin-top: 20px;">
                    <div class="button-group">
                        <button id="approve-btn" class="btn btn-success">‚úì Approve AI Solution</button>
                        <button id="intervene-btn" class="btn btn-warning">‚ö† Intervene & Modify</button>
                    </div>
                </div>
                {% elif loa == 4 %}
                <!-- LOA 4: Accept/View/Reject Controls -->
                <div class="loa4-controls" style="margin-top: 20px;">
                    <div class="button-group">
                        <button id="accept-loa4-btn" class="btn btn-success">‚úì Accept</button>
                        <button id="view-reasoning-btn" class="btn btn-primary">üëÅ View AI Reasoning</button>
                        <button id="reject-loa4-btn" class="btn btn-danger">‚úó Reject & Modify</button>
                    </div>
                </div>
                {% endif %}
                
                <!-- Submit Button (appears after action taken) -->
                <div id="submit-container" style="display: none; margin-top: 20px;">
                    <button id="submit-btn" class="btn btn-primary">Continue to Questionnaire ‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- Post-task Questionnaire Modal -->
        <div id="questionnaire-modal" class="modal">
            <div class="modal-content">
                <h2>Post-Task Questions</h2>
                
                <div class="question">
                    <label>How confident are you in the final answer?</label>
                    <div class="likert-scale">
                        <span>1 (Not at all)</span>
                        <input type="radio" name="confidence" value="1" required>
                        <input type="radio" name="confidence" value="2">
                        <input type="radio" name="confidence" value="3">
                        <input type="radio" name="confidence" value="4">
                        <input type="radio" name="confidence" value="5">
                        <input type="radio" name="confidence" value="6">
                        <input type="radio" name="confidence" value="7">
                        <span>7 (Extremely)</span>
                    </div>
                </div>
                
                {% if loa != 1 %}
                <div class="question">
                    <label>How much did you trust the AI's reasoning?</label>
                    <div class="likert-scale">
                        <span>1 (Not at all)</span>
                        <input type="radio" name="trust" value="1" required>
                        <input type="radio" name="trust" value="2">
                        <input type="radio" name="trust" value="3">
                        <input type="radio" name="trust" value="4">
                        <input type="radio" name="trust" value="5">
                        <input type="radio" name="trust" value="6">
                        <input type="radio" name="trust" value="7">
                        <span>7 (Completely)</span>
                    </div>
                </div>
                
                <div class="question">
                    <label>How aware did you feel of what the AI was doing?</label>
                    <div class="likert-scale">
                        <span>1 (Not aware)</span>
                        <input type="radio" name="awareness" value="1" required>
                        <input type="radio" name="awareness" value="2">
                        <input type="radio" name="awareness" value="3">
                        <input type="radio" name="awareness" value="4">
                        <input type="radio" name="awareness" value="5">
                        <input type="radio" name="awareness" value="6">
                        <input type="radio" name="awareness" value="7">
                        <span>7 (Very aware)</span>
                    </div>
                </div>
                {% endif %}
                
                <button id="submit-questionnaire-btn" class="btn btn-primary">Submit & Continue</button>
            </div>
        </div>
    </div>
    
    <script>
        // Data collection variables
        const LOA = {{ loa }};
        const puzzleStartTime = Date.now();
        let decisionStartTime = null;
        let interactionCount = 0;
        let finalAnswer = '';
        let acceptedAdvice = false;
        let overridden = false;
        
        // Timer
        let timerInterval;
        let elapsedSeconds = 0;
        
        function startTimer() {
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                document.getElementById('timer').textContent = 
                    `‚è±Ô∏è Time: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        // Log interaction
        async function logInteraction(type, details = {}) {
            interactionCount++;
            await fetch('/log-interaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: type,
                    details: details
                })
            });
        }
        
        // Show submit button
        function showSubmitButton() {
            document.getElementById('submit-container').style.display = 'block';
        }
        
        // ============== DRAG AND DROP FUNCTIONALITY ==============
        const solutionZone = document.getElementById('solution-zone');
        const sourceItems = document.getElementById('source-items');
        const clearBtn = document.getElementById('clear-solution-btn');
        let solutionSequence = [];
        let draggedElement = null;
        let isModifyingAllowed = true; // For LOA 3 and 4 initial lock
        
        // Get current solution as array
        function getCurrentSolution() {
            const items = solutionZone.querySelectorAll('.drag-item');
            return Array.from(items).map(item => item.dataset.element);
        }
        
        // Update final answer when solution changes
        function updateFinalAnswer() {
            solutionSequence = getCurrentSolution();
            finalAnswer = solutionSequence.join(', ');
            
            if (solutionSequence.length > 0) {
                clearBtn.style.display = 'inline-block';
                // Hide empty state
                const emptyState = solutionZone.querySelector('.empty-state');
                if (emptyState) emptyState.style.display = 'none';
                
                // Show submit button if solution is complete
                const totalElements = {{ puzzle.elements|length }};
                if (solutionSequence.length === totalElements) {
                    showSubmitButton();
                }
            } else {
                clearBtn.style.display = 'none';
                const emptyState = solutionZone.querySelector('.empty-state');
                if (emptyState) emptyState.style.display = 'block';
            }
        }
        
        // Drag start handler
        function handleDragStart(e) {
            if (!isModifyingAllowed) return;
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            logInteraction('drag_start', { element: this.dataset.element });
        }
        
        // Drag end handler
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
        }
        
        // Drag over handler
        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        // Drop handler for solution zone
        function handleDropInSolution(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (!draggedElement || !isModifyingAllowed) return false;
            
            e.preventDefault();
            
            const dropTarget = e.target;
            
            // If dropping on another item, insert before it
            if (dropTarget.classList.contains('drag-item') && dropTarget !== draggedElement) {
                solutionZone.insertBefore(draggedElement, dropTarget);
            } else if (dropTarget === solutionZone || dropTarget.classList.contains('empty-state')) {
                // Dropping in empty zone or on empty state
                solutionZone.appendChild(draggedElement);
            }
            
            logInteraction('drop_in_solution', { 
                element: draggedElement.dataset.element,
                position: Array.from(solutionZone.children).indexOf(draggedElement)
            });
            
            updateFinalAnswer();
            return false;
        }
        
        // Drop handler for source (return to pool)
        function handleDropInSource(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (!draggedElement || !isModifyingAllowed) return false;
            
            e.preventDefault();
            sourceItems.appendChild(draggedElement);
            
            logInteraction('return_to_pool', { element: draggedElement.dataset.element });
            updateFinalAnswer();
            return false;
        }
        
        // Initialize drag and drop for all items
        function initializeDragAndDrop() {
            const allItems = document.querySelectorAll('.drag-item');
            allItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
            
            solutionZone.addEventListener('dragover', handleDragOver);
            solutionZone.addEventListener('drop', handleDropInSolution);
            
            sourceItems.addEventListener('dragover', handleDragOver);
            sourceItems.addEventListener('drop', handleDropInSource);
        }
        
        // Clear solution button
        clearBtn.addEventListener('click', () => {
            const itemsInSolution = solutionZone.querySelectorAll('.drag-item');
            itemsInSolution.forEach(item => {
                sourceItems.appendChild(item);
            });
            logInteraction('clear_solution');
            updateFinalAnswer();
        });
        
        // ============== LOA-SPECIFIC LOGIC ==============
        
        // LOA 1: Manual drag and drop
        if (LOA === 1) {
            decisionStartTime = Date.now();
            initializeDragAndDrop();
        }
        
        // LOA 2: Drag and drop with hints
        if (LOA === 2) {
            decisionStartTime = Date.now();
            initializeDragAndDrop();
            
            const hints = {{ puzzle.hints | tojson }};
            let currentHintIndex = 0;
            
            const hintBtn = document.getElementById('hint-btn');
            const hintsContainer = document.getElementById('hints-container');
            const hintsRemaining = document.getElementById('hints-remaining');
            
            hintBtn.addEventListener('click', () => {
                if (currentHintIndex < hints.length) {
                    const hintDiv = document.createElement('div');
                    hintDiv.className = 'hint-item';
                    hintDiv.innerHTML = `<strong>Hint ${currentHintIndex + 1}:</strong> ${hints[currentHintIndex]}`;
                    hintsContainer.appendChild(hintDiv);
                    
                    logInteraction('request_hint', { 
                        hint_number: currentHintIndex + 1,
                        hint_text: hints[currentHintIndex]
                    });
                    
                    currentHintIndex++;
                    hintsRemaining.textContent = hints.length - currentHintIndex;
                    
                    if (currentHintIndex >= hints.length) {
                        hintBtn.disabled = true;
                        hintBtn.textContent = 'üí° No more hints';
                    }
                }
            });
        }
        
        // LOA 3: Pre-fill AI solution, allow approve or intervene
        if (LOA === 3) {
            decisionStartTime = Date.now();
            
            // Pre-populate solution zone with AI solution
            const aiSolution = '{{ ai_solution }}'.split(', ');
            aiSolution.forEach(element => {
                const item = sourceItems.querySelector(`[data-element="${element}"]`);
                if (item) {
                    solutionZone.appendChild(item);
                }
            });
            updateFinalAnswer();
            
            // Initially lock modifications
            isModifyingAllowed = false;
            document.querySelectorAll('.drag-item').forEach(item => {
                item.style.opacity = '0.7';
                item.style.cursor = 'not-allowed';
            });
            
            document.getElementById('approve-btn').addEventListener('click', () => {
                logInteraction('approve_ai_solution');
                acceptedAdvice = true;
                showSubmitButton();
                document.querySelectorAll('.loa3-controls button').forEach(btn => btn.disabled = true);
            });
            
            document.getElementById('intervene-btn').addEventListener('click', () => {
                logInteraction('intervene');
                overridden = true;
                isModifyingAllowed = true;
                
                // Enable drag and drop
                initializeDragAndDrop();
                document.querySelectorAll('.drag-item').forEach(item => {
                    item.style.opacity = '1';
                    item.style.cursor = 'grab';
                });
                
                document.querySelectorAll('.loa3-controls button').forEach(btn => btn.disabled = true);
                
                // Monitor changes to solution
                const observer = new MutationObserver(() => {
                    if (getCurrentSolution().length > 0) {
                        showSubmitButton();
                    }
                });
                observer.observe(solutionZone, { childList: true });
            });
        }
        
        // LOA 4: Pre-fill AI solution, allow accept/view/reject
        if (LOA === 4) {
            decisionStartTime = Date.now();
            let reasoningViewed = false;
            
            // Pre-populate solution zone with AI solution
            const aiSolution = '{{ ai_solution }}'.split(', ');
            aiSolution.forEach(element => {
                const item = sourceItems.querySelector(`[data-element="${element}"]`);
                if (item) {
                    solutionZone.appendChild(item);
                }
            });
            updateFinalAnswer();
            
            // Initially lock modifications
            isModifyingAllowed = false;
            document.querySelectorAll('.drag-item').forEach(item => {
                item.style.opacity = '0.7';
                item.style.cursor = 'not-allowed';
            });
            
            document.getElementById('accept-loa4-btn').addEventListener('click', () => {
                logInteraction('accept_ai_solution', { reasoning_viewed: reasoningViewed });
                acceptedAdvice = true;
                showSubmitButton();
                document.querySelectorAll('.loa4-controls button').forEach(btn => btn.disabled = true);
            });
            
            document.getElementById('view-reasoning-btn').addEventListener('click', () => {
                const reasoningDiv = document.getElementById('ai-reasoning-loa4');
                if (reasoningDiv.style.display === 'none') {
                    reasoningDiv.style.display = 'block';
                    reasoningViewed = true;
                    logInteraction('view_ai_reasoning');
                    document.getElementById('view-reasoning-btn').textContent = 'üëÅ Hide AI Reasoning';
                } else {
                    reasoningDiv.style.display = 'none';
                    document.getElementById('view-reasoning-btn').textContent = 'üëÅ View AI Reasoning';
                }
            });
            
            document.getElementById('reject-loa4-btn').addEventListener('click', () => {
                logInteraction('reject_ai_solution', { reasoning_viewed: reasoningViewed });
                overridden = true;
                isModifyingAllowed = true;
                
                // Enable drag and drop
                initializeDragAndDrop();
                document.querySelectorAll('.drag-item').forEach(item => {
                    item.style.opacity = '1';
                    item.style.cursor = 'grab';
                });
                
                document.getElementById('accept-loa4-btn').disabled = true;
                document.getElementById('reject-loa4-btn').disabled = true;
                
                // Monitor changes to solution
                const observer = new MutationObserver(() => {
                    if (getCurrentSolution().length > 0) {
                        showSubmitButton();
                    }
                });
                observer.observe(solutionZone, { childList: true });
            });
        }
        
        // Submit button handler
        document.getElementById('submit-btn').addEventListener('click', () => {
            if (!finalAnswer || finalAnswer.trim().length === 0) {
                alert('Please provide a solution before continuing.');
                return;
            }
            
            clearInterval(timerInterval);
            document.getElementById('questionnaire-modal').style.display = 'flex';
        });
        
        // Questionnaire submission
        document.getElementById('submit-questionnaire-btn').addEventListener('click', async () => {
            const confidence = document.querySelector('input[name="confidence"]:checked');
            const trust = LOA !== 1 ? document.querySelector('input[name="trust"]:checked') : null;
            const awareness = LOA !== 1 ? document.querySelector('input[name="awareness"]:checked') : null;
            
            if (!confidence || (LOA !== 1 && (!trust || !awareness))) {
                alert('Please answer all questions before continuing.');
                return;
            }
            
            const decisionLatency = decisionStartTime ? (Date.now() - decisionStartTime) / 1000 : 0;
            
            const submissionData = {
                final_answer: finalAnswer,
                decision_latency: decisionLatency,
                accepted_advice: acceptedAdvice,
                overridden: overridden,
                confidence_score: parseInt(confidence.value),
                trust_score: trust ? parseInt(trust.value) : 0,
                awareness_score: awareness ? parseInt(awareness.value) : 0
            };
            
            try {
                const response = await fetch('/submit-puzzle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.next_step === 'loa_intro') {
                        window.location.href = '/loa-intro';
                    } else {
                        window.location.href = '/final';
                    }
                }
            } catch (error) {
                alert('Error submitting data. Please try again.');
            }
        });
        
        // Start timer when page loads
        startTimer();
    </script>
</body>
</html>
